rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function hasUserDoc() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function currentRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function hasAnyRole() {
      return hasUserDoc() && currentRole() in ['Produtor', 'Gestor', 'Operador', 'Integradora', 'Fornecedor', 'TÃ©cnico', 'Tecnico', 'Investidor', 'Gestor de Trafego', 'Administrador'];
    }

    function claimRole() {
      return signedIn() && request.auth.token.role is string
        ? request.auth.token.role
        : null;
    }

    function claimTenantId() {
      return signedIn() && request.auth.token.tenantId is string
        ? request.auth.token.tenantId
        : null;
    }

    function currentTenantId() {
      return hasUserDoc() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId : null;
    }

    function hasTenantAccess(tenantId) {
      return signedIn() && (
        claimTenantId() == tenantId ||
        // Transitional fallback (1 release) while all users receive custom claims.
        (hasUserDoc() && currentTenantId() == tenantId)
      );
    }

    function isSeedProducer() {
      return signedIn()
        && claimRole() == 'PRODUCER'
        && request.auth.token.producerScopes is map
        && request.auth.token.producerScopes.seedProducer == true;
    }

    function isProducerRole() {
      return signedIn() && (
        claimRole() == 'PRODUCER' ||
        (hasUserDoc() && currentRole() == 'Produtor')
      );
    }

    function isSupplierRole() {
      return signedIn() && (
        claimRole() == 'SUPPLIER' ||
        (hasUserDoc() && currentRole() == 'Fornecedor')
      );
    }

    function isIntegratorRole() {
      return signedIn() && (
        claimRole() == 'INTEGRATOR' ||
        (hasUserDoc() && currentRole() == 'Integradora')
      );
    }

    function isManagerRole() {
      return signedIn() && (
        claimRole() == 'MANAGER' ||
        (hasUserDoc() && currentRole() == 'Gestor')
      );
    }

    function isAdminRole() {
      return signedIn() && (
        claimRole() == 'ADMIN' ||
        (hasUserDoc() && currentRole() == 'Administrador')
      );
    }

    function listingCategoryValid(data) {
      return data.listingCategory is string
        && data.listingCategory in ['OUTPUTS_PRODUCER', 'INPUTS_INDUSTRY', 'AUCTION_P2P'];
    }

    function listingModeValidForCategory(data) {
      return !(data.listingCategory == 'AUCTION_P2P')
        || (data.listingMode is string && data.listingMode == 'AUCTION');
    }

    function listingStatusValid(data) {
      return !(data.status is string) || data.status in ['DRAFT', 'PUBLISHED', 'PAUSED', 'CLOSED'];
    }

    function listingStatusTransitionAllowed() {
      return request.resource.data.status == resource.data.status
        || request.resource.data.status in ['PUBLISHED', 'PAUSED', 'CLOSED'];
    }

    function listingCategoryImmutable() {
      return request.resource.data.listingCategory == resource.data.listingCategory;
    }

    function canWriteListingCategory(data) {
      return isAdminRole()
        || isManagerRole()
        || (isProducerRole() && data.listingCategory in ['OUTPUTS_PRODUCER', 'AUCTION_P2P'])
        || (isSupplierRole() && data.listingCategory == 'INPUTS_INDUSTRY');
    }

    match /users/{userId} {
      allow read: if isOwner(userId) || hasAnyRole();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || hasAnyRole();
      allow delete: if false;
    }

    match /properties/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /pastures/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /productionProjects/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /inventoryItems/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /stockMovements/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /auditEvents/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /bankAccounts/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /receivables/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /expenses/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /transactions/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /marketplaceListings/{docId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && listingCategoryValid(request.resource.data)
        && listingModeValidForCategory(request.resource.data)
        && listingStatusValid(request.resource.data)
        && canWriteListingCategory(request.resource.data);
      allow update: if signedIn()
        && listingCategoryValid(request.resource.data)
        && listingModeValidForCategory(request.resource.data)
        && listingStatusValid(request.resource.data)
        && listingCategoryImmutable()
        && listingStatusTransitionAllowed()
        && canWriteListingCategory(resource.data)
        && (isAdminRole() || isManagerRole() || request.auth.uid == resource.data.createdByUserId);
      allow delete: if false;
    }

    match /corporateCards/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /partnerStores/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /logisticsEntries/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /contracts/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /salesOffers/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /employees/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /timeRecords/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /payrollEntries/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /ppeOrders/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /marketTrends/{docId} {
      allow read: if true;
      allow write: if hasAnyRole();
    }

    match /reportConsumptions/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /reportCapacity/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /sustainablePractices/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /carbonProjects/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /carbonCredits/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /regionalStats/{docId} {
      allow read: if true;
      allow write: if hasAnyRole();
    }

    match /newsItems/{docId} {
      allow read: if true;
      allow write: if hasAnyRole();
    }

    match /auctionListings/{docId} {
      allow read: if true;
      allow write: if hasAnyRole();
    }

    match /marketSaturation/{docId} {
      allow read: if true;
      allow write: if hasAnyRole();
    }

    match /publicMarketPrices/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /publicMarketPrices/{docId}/points/{pointId} {
      allow read: if true;
      allow write: if false;
    }

    match /publicMarketIndices/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /publicMarketConfig/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /operatorRequests/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /operatorTasks/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /supplierOrders/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /marketplaceOrders/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /supplierFinancials/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /integratedProducers/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /partnershipOffers/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /integratorMessages/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /financialDetails/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /animalDetails/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /sectorDetails/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /stageDetails/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /projectStages/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /technicianKpis/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /technicianReports/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /seedFields/{docId} {
      allow read, write: if false;
    }

    match /seedLots/{docId} {
      allow read, write: if false;
    }

    match /seedCertifications/{docId} {
      allow read, write: if false;
    }

    match /investorKpis/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /investorProjects/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /managerKpis/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /managerActivities/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /managementAlerts/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /managementHistory/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /marketOpportunities/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /fieldDiaryEntries/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /liveHandlingContext/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /liveHandlingHistory/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /integrationStatus/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /integrationRequests/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /aiAnalyses/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /operationalActions/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /customInputRequests/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /customInputFormulas/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /customInputPastures/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /systemConfigs/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /dataDictionaryEntities/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /operationsTable/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /eventsMatrix/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /liquidationFlows/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /architectureNodes/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /legalContracts/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /legalLicenses/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /legalComplianceAlerts/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /carRegistry/{docId} {
      allow read: if signedIn();
      allow write: if hasAnyRole();
    }

    match /carQueries/{docId} {
      allow read: if hasAnyRole();
      allow write: if signedIn();
    }

    match /tenants/{tenantId}/seedFields/{docId} {
      allow read, create, update: if false;
      allow delete: if false;
    }

    match /tenants/{tenantId}/seedLots/{docId} {
      allow read, create, update: if false;
      allow delete: if false;
    }

    match /tenants/{tenantId}/seedCertifications/{docId} {
      allow read, create, update: if false;
      allow delete: if false;
    }

    match /tenants/{tenantId}/marketListings/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow create: if hasTenantAccess(tenantId)
        && request.resource.data.tenantId == tenantId
        && listingCategoryValid(request.resource.data)
        && listingModeValidForCategory(request.resource.data)
        && listingStatusValid(request.resource.data)
        && canWriteListingCategory(request.resource.data);
      allow update: if hasTenantAccess(tenantId)
        && request.resource.data.tenantId == resource.data.tenantId
        && listingCategoryValid(request.resource.data)
        && listingModeValidForCategory(request.resource.data)
        && listingStatusValid(request.resource.data)
        && listingCategoryImmutable()
        && listingStatusTransitionAllowed()
        && canWriteListingCategory(resource.data)
        && (isAdminRole() || isManagerRole() || request.auth.uid == resource.data.createdByUserId);
      allow delete: if false;
    }

    match /tenants/{tenantId}/marketOrders/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/marketContracts/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/settlements/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/evidences/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/disputes/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/moduleEvents/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/auditLogs/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow create: if hasTenantAccess(tenantId) && currentRole() in ['Gestor', 'Administrador', 'Gestor de Trafego'];
      allow update, delete: if false;
    }

    match /tenants/{tenantId}/supportTickets/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/messages/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/approvalRequests/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /tenants/{tenantId}/approvalsAuditEvents/{docId} {
      allow read: if hasTenantAccess(tenantId);
      allow write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

